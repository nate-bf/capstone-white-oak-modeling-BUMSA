---
title: "White Oak Exploration"
author: "Paul Forst, Tammy Hang, Rachel Kopecky, Jack Letcher, Ian O'Connor"
output:
  html_document:
    theme: sandstone
    toc: yes
    toc_depth: 4
    toc_float: yes
  html_notebook:
    fig_caption: yes
    highlight: textmate
    theme: sandstone
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9)

library(tidyverse)
library(ggplot2)
library(readr)
library(tibbletime)
```

# Data

### White Oak

The White Oak data used for this analysis was received from the U.S. Forest Service (USFS). The data contains annual, unit level volumes for White Oak on private, non-industrial lands in the Eastern United States, and includes detail on the Growing Stock Inventory, Growth, Removal, and Mortality in cubic feet. The data spans the period 1968 through 2017.

### Climate

### Drought

### Urbanization

### Invasive Species

# Exploration

### White Oak

#### Inventory

The plot below shows the total White Oak inventory from 1968 through 2017, as recorded in the USFS database.

```{r}
# Read in and manipulate inventory data. These are the raw files from the US Forest service.
inv23 <- read_csv("WhiteOakData/white_oak_inv_23.csv")
inv24 <- read_csv("WhiteOakData/white_oak_inv_24.csv")
inv33 <- read_csv("WhiteOakData/white_oak_inv_33.csv")

inventory <- rbind(inv23, inv24, inv33)

inventory[is.na(inventory)] <- 0

# Create an identifier
inventory$UNIT <- paste0(inventory$STATECD, "0", inventory$UNITCD)

inventory %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_inventory = sum(SELECT_WHITE_OAK_INV_CUFT_GS, na.rm = TRUE)) %>% 
  ggplot(aes(x = EVAL_GRP_YEAR, y = total_inventory)) +
  geom_line() +
  labs(title = "White Oak Inventory (1968 - 2017)",
       y = "White Oak, Cubic Feet",
       x = "Year") +
  theme_minimal()
```

From this plot we can see a very severe increase in the total inventory after the year 2000. After speaking with the USFS, we have discovered that this is a result of switching from a periodic to an annual collection method in the early 2000's. This transition led the USFS to begin collecting data from samples of all states each year, rather than the entirety of just a few states under the periodic method.

#### Growth, Removal, Mortality

The next plot shows the annual growth, removal, and mortality of the White Oak population. We would expect to see similar patterns around the year 2000, to coincide with the change in collection method.

```{r}
# Read in growth, removal, mortality data
oak <- read_csv("WhiteOakData/white-oak-clean.csv")
oak[is.na(oak)] <- 0

oak %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_removal = sum(SELECT_WHITE_OAK_REMOVAL, na.rm = TRUE),
            total_growth = sum(SELECT_WHITE_OAK_GROWTH, na.rm = TRUE),
            total_mortality = sum(SELECT_WHITE_OAK_MORTALITY, na.rm = TRUE)) %>% 
  gather("type",
         "value",
         -EVAL_GRP_YEAR) %>% 
  ggplot(aes(x = EVAL_GRP_YEAR, y = value, colour = type)) +
  geom_line() +
  labs(title = "White Oak Growth, Removal, and Mortality (1968 - 2017)",
       y = "White Oak, Cubic Feet",
       x = "Year") +
  theme_minimal()
```

We do see the increase in each after the year 2000, which means that our data is consistent across fields. However, because of this change in collection method, any forecast based off the raw values would most likely over-forecast the increasing trend into the future. 

To get a better idea of how growth, removal, and mortality have truly changed over the years, we can plot each of these as a percentage of the total inventory. 

```{r}
oak_merge <- oak %>% 
  group_by(STATE_ABBR, EVAL_GRP_YEAR, UNIT) %>% 
  summarise(total_removal = sum(SELECT_WHITE_OAK_REMOVAL, na.rm = TRUE),
            total_growth = sum(SELECT_WHITE_OAK_GROWTH, na.rm = TRUE),
            total_mortality = sum(SELECT_WHITE_OAK_MORTALITY, na.rm = TRUE))

inventory_merge <- inventory %>% 
  group_by(STATE_ABBR, EVAL_GRP_YEAR, UNIT) %>% 
  summarise(total_inventory = sum(SELECT_WHITE_OAK_INV_CUFT_GS, na.rm = TRUE))

oak_total <- merge(oak_merge, inventory_merge, by = c("STATE_ABBR", "EVAL_GRP_YEAR", "UNIT"))

oak_total %>% 
  group_by(EVAL_GRP_YEAR) %>% 
  summarise(total_growth = sum(total_growth),
            total_removal = sum(total_removal),
            total_mortality = sum(total_mortality),
            total_inventory = sum(total_inventory)) %>% 
  mutate(removal_pct_inventory = total_removal/total_inventory,
         growth_pct_inventory = total_growth/total_inventory,
         mortality_pct_inventory = total_mortality/total_inventory) %>% 
  select(EVAL_GRP_YEAR, removal_pct_inventory, growth_pct_inventory, mortality_pct_inventory) %>% 
  gather("type",
         "value",
         -EVAL_GRP_YEAR) %>%   
  ggplot(aes(x = EVAL_GRP_YEAR, y = value, colour = type)) +
  geom_line() +
  labs(title = "Growth, Removal, Mortality - Percent of Total Inventory (1968 - 2017)",
       y = "Percent of Inventory",
       x = "Year") +
  theme_minimal()

#Grab list of eastern states included in Oak data for use in other data sets
eastern_states <- unique(oak$STATE_ABBR)
```

We see a lot of variation in the growth and removal data during the time of the periodic collection method, and we see a lot of the trend smooth out in the early 2000s. From the plot above, we notice a downward trend in both growth and removal, while we see an upward trend in mortality. 

To properly weight our other potential factors on a national level, we need to know the percentage of oak inventory in each state. 

```{r}
#Generate percent of total population by state
oak_yearly <- oak_total %>% 
        group_by(EVAL_GRP_YEAR) %>% 
        summarise(national_inventory = sum(total_inventory),
                  national_growth = sum(total_growth),
                  national_mortality = sum(total_mortality),
                  national_removal = sum(total_removal))

oak_state_year <- oak_total %>% 
        group_by(STATE_ABBR, EVAL_GRP_YEAR) %>% 
        summarise(state_inventory = sum(total_inventory),
                  state_growth = sum(total_growth),
                  state_mortality = sum(total_mortality),
                  state_removal = sum(total_removal)) %>% 
        merge(oak_yearly, by = "EVAL_GRP_YEAR") %>% 
        mutate(perc_inventory = state_inventory / national_inventory,
               perc_growth = state_growth / national_growth,
               perc_mortality = state_mortality / national_mortality,
               perc_removal = state_removal / national_removal)

```


### Urbanization

#### Urban Land Area

Urbanization is something that the USFS uses in their forecasting, so we would also like to implement this in ours, as it may have some predictive power. The plot below shows the United States urban land area in square miles. Unfortunately, we have only been able to find this data in 10 year intervals thus far, and that may not be enough information to even interpolate the missing values.

```{r}
urban_area <- read_csv("UrbanizationData/urban_land_area.csv")

urban_area <- gather(urban_area, 
                     "year", 
                     "urban_land_area_square_miles", 
                     -Type)

urban_area <- na.omit(urban_area)
urban_area$urban_land_area_square_miles <- as.numeric(urban_area$urban_land_area_square_miles)

urban_area %>% 
  ggplot(aes(x = year, y = urban_land_area_square_miles)) +
  geom_point() +
  labs(title = "Urban Land Area",
       y = "Land Area (Square Miles)",
       x = "Year") +
  theme_minimal()
```

Although we do not have annual values, there is a clear upward trend in the urban land area. Hopefully we will be able to find additional data and/or a valid method for interpolating these values.

### Drought

#### Percent of Drought Land

We also wanted to see if the percent of land under various drought conditions has any relation to white oak growth, mortality, and removal.

```{r}
drought_national <- read_csv("ClimateData/drought_national.csv")

drought_national$ReleaseDate <- as.character(drought_national$ReleaseDate)
drought_national$ReleaseDate <- as.Date(drought_national$ReleaseDate, "%Y%m%d")

drought_national_annual <- drought_national %>% 
  arrange(ReleaseDate) %>% 
  mutate(Date = collapse_index(ReleaseDate, "yearly")) %>% 
  group_by(Date) %>% 
  summarise(None = mean(None), 
            D0 = mean(D0),
            D1 = mean(D1),
            D2 = mean(D2),
            D3 = mean(D3),
            D4 = mean(D4))

drought_national_annual %>% 
  gather("type",
         "percent",
         -Date) %>% 
  ggplot(aes(x = Date, y = percent, colour = type)) +
  geom_line() +
  labs(title = "Annual Percent of Drought Land",
       y = "Percent of Drought Land",
       x = "Year") +
  theme_minimal()
```

It is not easy to identify any real trend in the annual percent of drought land. This type of data may not make sense at an annual level, as we had to take the mean of weekly data, and any variation/trend may have been washed out in the average.

#### Palmer Drought Severity Index (PDSI)

The Palmer Drought Severity Index is a measure of dryness in a region based on the amount of recent precipitation and overall temperature. It typically ranges from -4 being an extreme drought to +4 for extreme moisture although it can exceed those points up to +/- 7.

Data: https://www.ncdc.noaa.gov/temp-and-precip/drought/historical-palmers/

```{r}
pdsi_data <- read.csv("ClimateData/PalmerDroughtSeverityIndex_raw.csv", header = FALSE)
#Explore a link to the data files online to allow update numbers as necessary
#Need to read 'procdate.txt' to get date then append it to the necessary file
#ftp://ftp.ncdc.noaa.gov/pub/data/cirs/climdiv/

#Read in file of county FIPS codes to state_division code
#climate_div_cty <- read.csv("ftp://ftp.ncdc.noaa.gov/pub/data/cirs/climdiv/cd_county_join.txt", 
#                            header = FALSE,
#                            stringsAsFactors = FALSE)
#climate_div_cty <- separate(climate_div_cty, 
#         col = 'V1',
#         into = c("State_Div", "County"),
#         remove = TRUE,
#         fill = 'right')

#Read in divisional area in sq mi and percent
division_area <- read_tsv("ClimateData/division_area.txt")
division_area[division_area == 0] <- NA
division_area <- division_area[-nrow(division_area),]
colnames(division_area) <- c("State_code","01","02","03","04","05","06","07","08","09","10","Total")
division_area$State_code <- as.character(as.numeric(division_area$State_code))
division_area_long <- division_area %>%
        gather(Division, 
               "LandArea",
               -c(State_code, Total),
               na.rm = TRUE) %>% 
        group_by(State_code, Division) %>% 
        summarise(percent_land = LandArea / Total)

pdsi_states <- read.csv("ClimateData/state_codes.csv")

colnames(pdsi_data) <- c("Division_Year","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

#Parse our the state, division and year from code
pdsi_data$State_code <- substr(pdsi_data$Division_Year, 1, nchar(pdsi_data$Division_Year)-8)
pdsi_data$Division <- substr(pdsi_data$Division_Year, nchar(pdsi_data$Division_Year)-7, nchar(pdsi_data$Division_Year)-6)
pdsi_data$Element_Code <- substr(pdsi_data$Division_Year, nchar(pdsi_data$Division_Year)-5, nchar(pdsi_data$Division_Year)-4)
pdsi_data$Year <- substr(pdsi_data$Division_Year, nchar(pdsi_data$Division_Year)-3, nchar(pdsi_data$Division_Year))

#Convert state code to name
pdsi_data <- merge(pdsi_data, pdsi_states)
#division_area_long <- merge(division_area_long, pdsi_states, by = "State_code")

#Replace missing values (-99.99) with NA
pdsi_data[pdsi_data == '-99.99'] <- NA

#Generate yearly average
pdsi_data$Yearly_Avg <- rowMeans(pdsi_data[,3:14])

#Remove unnecessary columns
pdsi_data_yearly <- pdsi_data[,-c(2:14)]

#Merge land percentages with PDSI
pdsi_data_yearly <- merge(pdsi_data_yearly, division_area_long, by = c("State_code", "Division"))

#Create Yearly State Total PDSI based on weighted divisions
pdsi_state_year <- pdsi_data_yearly %>% 
        group_by(Abbreviation, Year) %>% 
        summarise(pdsi = sum(Yearly_Avg * percent_land))

#Generate Index based on state abbreviation and year
pdsi_state_year$state_yr <- paste0(pdsi_state_year$Abbreviation, pdsi_state_year$Year)

inventory_yr_state <- oak_total %>% 
        mutate(state_yr = paste0(STATE_ABBR,EVAL_GRP_YEAR)) %>% 
        group_by(state_yr, STATE_ABBR, EVAL_GRP_YEAR) %>% 
        summarise(total_growth = sum(total_growth),
                  total_removal = sum(total_removal),
                  total_mortality = sum(total_mortality),
                  total_inventory = sum(total_inventory))

inventory_pdsi <- merge(inventory_yr_state, pdsi_state_year, by = "state_yr")

inventory_pdsi %>% 
        mutate(mortality_div = total_mortality/1000000) %>% 
        select(Abbreviation, Year, mortality_div, pdsi) %>% 
        filter(Year >= 2005)%>%
        gather("Measure",
               "Value",
               -Abbreviation, 
               -Year) %>% 
        filter(Abbreviation == 'AL') %>% 
        ggplot(aes(x = Year, y = Value, colour = Measure, group = Measure)) +
                geom_line() +
                labs(title = "Yearly Mortality and PDSI for Alabama",
                     y = "Measure",
                     x = "Year") +
        scale_colour_manual(labels = c("Mortality (in millions)", "PDSI"), values = c("darkblue", "red")) +
                theme_minimal()

#Average annual level by state
#pdsi_data %>% 
#        filter(Abbreviation %in% eastern_states) %>% 
#        filter(Year > 1968) %>% 
#        ggplot(aes(x = Year, y = Yearly_Avg, colour = Abbreviation)) +
#        geom_line() +
#        labs(title = "Annual Palmer Drought Serverity Index",
#             y = "Index",
#             x = "Year") +
#        theme_minimal()

```

# TO DO

* Filter urbanization and drought land data to include only the Eastern states that are relevant to the White Oak analysis. This may or may not impact any correlation in trends that we see.